name: Auto Merge PRs

on:
  workflow_call:

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get merge count and PR list
        id: fetch-prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // PR에서 MD 파일의 frontmatter date 추출
            async function getPostDateFromPR(pr) {
              try {
                // PR에서 변경된 파일 목록 조회
                const { data: files } = await github.rest.pulls.listFiles({
                  owner,
                  repo,
                  pull_number: pr.number
                });

                // MD 파일 필터링 (contents/ 디렉토리 내 index.md 우선)
                const mdFiles = files.filter(f => f.filename.endsWith('.md'));
                if (mdFiles.length === 0) return null;

                // 첫 번째 MD 파일 내용 조회
                const targetFile = mdFiles.find(f => f.filename.includes('index.md')) || mdFiles[0];
                const { data: content } = await github.rest.repos.getContent({
                  owner,
                  repo,
                  path: targetFile.filename,
                  ref: pr.head.ref
                });

                // Base64 디코딩 및 frontmatter date 파싱
                const fileContent = Buffer.from(content.content, 'base64').toString('utf-8');
                const dateMatch = fileContent.match(/^---[\s\S]*?date:\s*(\d{4}-\d{2}-\d{2})[\s\S]*?---/);

                return dateMatch ? dateMatch[1] : null;
              } catch (error) {
                console.log(`Failed to get date from PR #${pr.number}: ${error.message}`);
                return null;
              }
            }

            // `MergeReady` 라벨이 있는 PR 목록 조회
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              per_page: 50
            });

            const mergeReadyPRs = prs.filter(pr =>
              pr.labels.some(label => label.name === "MergeReady")
            );

            if (mergeReadyPRs.length === 0) {
              console.log("No MergeReady PRs found.");
              return;
            }

            // 각 PR에 postDate 추가
            for (const pr of mergeReadyPRs) {
              pr.postDate = await getPostDateFromPR(pr);
              console.log(`PR #${pr.number}: postDate=${pr.postDate || 'N/A'}`);
            }

            // 미래 날짜 PR 제외 (date가 없으면 포함)
            const eligiblePRs = mergeReadyPRs.filter(pr => {
              if (!pr.postDate) return true;
              const postDate = new Date(pr.postDate);
              const isEligible = postDate <= today;
              console.log(`PR #${pr.number}: eligible=${isEligible}`);
              return isEligible;
            });

            if (eligiblePRs.length === 0) {
              console.log("No eligible PRs (all have future dates).");
              return;
            }

            // postDate 기준 정렬 (오래된 날짜 우선, date 없으면 created_at 사용)
            eligiblePRs.sort((a, b) => {
              const dateA = a.postDate ? new Date(a.postDate) : new Date(a.created_at);
              const dateB = b.postDate ? new Date(b.postDate) : new Date(b.created_at);
              return dateA - dateB;
            });

            // PR 개수에 따라 MAX_WEEKLY_MERGES 설정
            let MAX_WEEKLY_MERGES = 1;
            if (eligiblePRs.length >= 5) MAX_WEEKLY_MERGES = 2;
            if (eligiblePRs.length >= 10) MAX_WEEKLY_MERGES = 3;
            if (eligiblePRs.length >= 15) MAX_WEEKLY_MERGES = 4;

            // 지난 7일간 merge 된 PR 개수 확인
            const { data: mergedPRs } = await github.rest.pulls.list({
              owner,
              repo,
              state: "closed",
              per_page: 50
            });

            const last7DaysMerges = mergedPRs.filter(pr =>
              pr.merged_at && new Date(pr.merged_at) >= new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000) &&
              pr.labels.some(label => label.name === "MergeReady")
            ).length;

            if (last7DaysMerges >= MAX_WEEKLY_MERGES) {
              console.log(`Weekly merge limit reached (${last7DaysMerges}/${MAX_WEEKLY_MERGES}).`);
              return;
            }

            // 가장 오래된 eligible PR 선택
            const selectedPR = eligiblePRs[0];
            console.log(`Selected PR: #${selectedPR.number} (postDate: ${selectedPR.postDate || 'N/A'})`);

            core.setOutput("pr_number", selectedPR.number);

      - name: Add comment to PR
        if: steps.fetch-prs.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.fetch-prs.outputs.pr_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: "자동 머지합니다"
            });

            console.log(`Comment added to PR #${prNumber}`);

      - name: Merge selected PR
        if: steps.fetch-prs.outputs.pr_number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.fetch-prs.outputs.pr_number }}
          merge-method: squash
